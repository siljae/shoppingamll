@startuml
title 구매 API 시퀀스 다이어그램

actor 사용자 as User
participant "ApiProductController" as Controller
participant "PurchaseService" as PurchaseService
participant "ProductStockRedisService" as ProductStockRedisService
participant "ProductMapper" as ProductMapper
participant "RedissonClient" as RedissonClient
participant "OrderService" as OrderService
participant "OrderMapper" as OrderMapper


User -> Controller : POST /api/products/{productId}/purchase(request)
activate Controller


Controller -> PurchaseService : purchase(productId)
activate PurchaseService

note right : 트랜잭션 시작
PurchaseService -> ProductStockRedisService : reduceStock(productId, 1)
activate ProductStockRedisService

ProductStockRedisService -> ProductMapper : getProductStockById(productId)
activate ProductMapper
ProductMapper --> ProductStockRedisService : maxStock
deactivate ProductMapper

ProductStockRedisService -> ProductStockRedisService : fetchProductSaleOrInitialize(productId)
activate ProductStockRedisService

opt (isExists == false)
    ProductStockRedisService -> ProductStockRedisService : updateRedisProductSaleCount(productId)
    activate ProductStockRedisService

    ProductStockRedisService -> RedissonClient : getLock(lock:productSaleKey)
    note left : 레디스 락 획득
    activate RedissonClient
    RedissonClient --> ProductStockRedisService : lock
    deactivate RedissonClient

    opt Lock Failed
        ProductStockRedisService --> ProductStockRedisService : LockNotAcquireException
        deactivate ProductStockRedisService
    end

    opt Lock Success && (isExists == false)
        ProductStockRedisService -> OrderMapper : getOrderCountByProductId(productId)
        activate ProductStockRedisService
        activate OrderMapper
        OrderMapper --> ProductStockRedisService : saleCount
        deactivate OrderMapper

        ProductStockRedisService -> RedissonClient : getAtomicLong(productSaleKey).set(saleCount)
        deactivate ProductStockRedisService
        note left : 락 반납
    end


end


ProductStockRedisService -> RedissonClient : getAtomicLong(productSaleKey)
activate RedissonClient
RedissonClient --> ProductStockRedisService : rSaleCount
deactivate RedissonClient

ProductStockRedisService --> ProductStockRedisService : currentSaleCount
deactivate ProductStockRedisService



opt (currentSaleCount + quantity) > maxStock
ProductStockRedisService --> Controller : OutOfStockException
end

ProductStockRedisService -> RedissonClient : getAtomicLong(productSaleKey).addAndGet(quantity)
activate RedissonClient
RedissonClient --> ProductStockRedisService : currentSale
deactivate RedissonClient

opt currentSale > maxStock
ProductStockRedisService -> RedissonClient : rProductSale.addAndGet(-quantity)
ProductStockRedisService --> Controller : OutOfStockException
end

ProductStockRedisService --> PurchaseService
deactivate ProductStockRedisService

PurchaseService -> OrderService : makeOrder(productId)
activate OrderService
OrderService -> OrderMapper : insertOrder(order)
activate OrderMapper
OrderMapper --> OrderService
deactivate OrderMapper
OrderService --> PurchaseService : Order
deactivate OrderService

PurchaseService --> Controller : Order
deactivate PurchaseService
note right : 트랜잭션 종료

Controller --> User : 구매가 완료되었습니다.
deactivate Controller

@enduml